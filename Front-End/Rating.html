<!DOCTYPE html>


<html style="height:100%;">

<head>
    <meta charset="utf-8">
    <title> Study Buddy|Books </title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="css/style.css">
    <script>
        //Checking if the account is logged in
        if (sessionStorage.token == null) {
            alert('You are not logged in');
            window.location.href = "Login.html";
        }
    </script>


</head>

<body>
    <header id="head2">
        <div class="container">
            <div id="branding">
                <h1>
                    Books
                </h1>
            </div>
            <nav>
                <a href="Home.html">HOME</a>
                <a href="Cart.html">CART</a>
                <a href="new 4.html">ABOUT US </a>
            </nav>

        </div>

        <form name="sform" id="sform">
            UserName:
            <input type="text" onkeypress="return (event.charCode >= 65 && event.charCode <=90)||event.charCode==95||(event.charCode>=48&&event.charCode<=57)||(event.charCode >= 97 && event.charCode <=122)|| event.charCode==13" name="title" id="title"> Sort:
            <select name="sort" id="sort" style="font-size:15px">
                <option value="Name">Name</option>
            </select>
        </form>
    </header>
    <div id="main">
        <table id="tab" cellspacing="0px" style="margin:10px">
            <thead>
                <th style="text-align:left">UserName</th>
                <th style="text-align:left">Rate</th>
            </thead>
            <tbody>


            </tbody>
        </table>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script> 
        $(document).ready(function (ev) {
            ev.preventdefault;
            $.ajax({
                type: "GET",
                url: 'http://localhost:3000/api/Users',
                headers: {
                    "x-access-token": sessionStorage.getItem('token')
                },
                success: function (response) {
                    if (!(response.Error)) {
                        var tablehtml = "";
                        //filling the table (tab)
                        for (var key in response.users) {
                            tablehtml += "<tr>"
                            tablehtml += "<td>" + response.users[key]["user_name"] + "</td>";
                            tablehtml += "<td>" + response.users[key]["user_rate"] + "</td>";
                            tablehtml += "</tr>";
                        }
                    }
                    $("#tab tbody").html(tablehtml); //this line adds the table created (tablehtml) in the tbody section of the body
                    var tables = document.getElementById("tab");
                    //these lines responsible for detecting the row clicked
                    for (i = 1; i < tables.rows.length; i++) {
                        var r = tables.rows[i];
                        r.onclick = function () {
                            if (!this.hilite) { //to highlight the selected row
                                this.origColor = this.style.backgroundColor;
                                this.style.backgroundColor = '#BCD4EC';
                                this.hilite = true;
                            }
                            var ind = this.rowIndex;
                            var username = this.getElementsByTagName("td")[0];
                            if (confirm("Rate " + username.innerHTML)) {
                                // what would happen if the user clicks ok (he wants to add the book)
                                var user = {   //the book that would be added to the cart
                                    name: username.innerHTML
                                }
                                //prompting the user to rate
                                var rate = prompt("Rate " + username.innerHTML + " 1-->5", "Harry Potter");
                                if (rate != null && rate < 6 && rate > 0) {
                                    var ratinginfo = {
                                        id: response.users[ind - 1].user_id,
                                        rating: rate
                                    }
                                    $.ajax({
                                        type: "POST",
                                        url: 'http://localhost:3000/api/rating',
                                        data: ratinginfo,
                                        headers: {
                                            "x-access-token": sessionStorage.getItem('token')
                                        },
                                        success: function (response) {
                                            if (response.Error == false){
                                                alert(response.Message);
                                                window.location.href="Rating.html";
                                            }
                                            else
                                                alert('You have already rated this user');
                                        },
                                        error: function (response) {
                                        }
                                    })
                                    
                                }
                                else {
                                    alert("Please enter the prompted values");
                                }
                            }
                            this.style.backgroundColor = this.origColor;
                            this.hilite = false;
                        }
                    }
                },
                error: function (response) {
                    console.log('Error in connection');
                }
            })
        })
    </script>


</body>

</html>